# 자바에서의 멀티쓰레드

---

## 멀티쓰레드란? 멀티 프로세스와의 차이는?


쓰레드는 프로세스의 실행 단위로, 각각의 스택을 가져 함수를 호출하며, 힙 등의 메모리 공간은 공유한다. 
- 멀티 쓰레드 환경에서는 힙 공간을 공유하여 데이터를 쉽게 주고 받을 수 있다는 점, context switch에서 캐시를 비울 필요가 없다는 점에서 빠르다.
- 그러나 자원을 공유하기 때문에 잘못된 값을 읽어 올 수 있다. 즉, 동기화 작업이 필요하다.
또한 쓰레드 하나가 오류를 일으켜 종료될 때 다른 쓰레드들이 합께 종료될 수 있다는 문제도 있다.

---
## 그렇다면 자바에서 여러 쓰레드를 사용하는 방법은 무엇인가?

- 쓰레드 객체를 자바에서 생성하는 법은 두 가지가 있다.
  - 첫째는 thread 클래스를 상속하는 것인데, 클래스의 여러 메소드를 이용할 수 있지만 다른 클래스를 상속할 수 없게 된다는 단점이 있다.
  - 함수형 인터페이스 runnable을 구현하는 법도 있는데, 인터페이스를 구현했기 때문에 다른 클래스를 상속하면서도 사용할 수 있다.
  - 후자가 주로 사용된다.

 - 그 후 start 메소드르 호출한다. run 메소드는 메인 쓰레드에서 객체 메소드를 실행하는 것이며, start를 통해 별도 쓰레드로 실행할 수 있다.

 - 쓰레드 사이의 우선순위를 지정하는 setPriority 등의 메소드가 있다.

---
## 그 멀티쓰레드 환경에서 동기화는 어떻게 이루어지는가?
- synchronized라는 modifier를 사용하면 된다. 메소드 선언에 붙이거나, synchronized this{ code }로 블록을 지정할 수 있다.
- 자료구조에서 동기화를 지원하기도 한다.
  - HashTable은 모든 메소드에 synchronized가 선언되어 있어 동기화를 제공하나 성능이 떨어진다.
  - ConcurrentHashMap을 보통 사용하는데, hashTanle과는 달리 엔트리 별로 락을 걸기 때문에 성능이 뛰어나다. 또한 검색 작업에는 락이 걸리지 않는다.

---


## 쓰레드가 별도 저장 공간을 가지게 하는 법은?
- ThreadLocal 클래스를 통해 사용한다.
- 스프링 시큐리티에서 인증 정보를 저장하기 위해, RequestContextHolder에서 요청 정보를 저장하기 위해 샤용.
- 쓰레드를 종료시키지 않는 쓰레드 풀을 사용하는 경우, 이전 정보를 사용하지 않도록 쓰레드를 풀에 반환할 때 반드시 ThreadLocal을 초기화해야 한다.
  - 스프링 시큐리티에스는 clearContext()로, RequestContextHolder에서는 resetRequestAttributes()로 초기화.

---
## Reference
---
- https://mangkyu.tistory.com/258
- https://tecoble.techcourse.co.kr/post/2021-11-26-hashmap-hashtable-concurrenthashmap/
- https://newwisdom.tistory.com/110
